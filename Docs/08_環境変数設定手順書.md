# 環境変数設定手順書

## 概要

ECShopアプリケーションでは、デプロイメント環境に応じてURLや接続先を柔軟に設定できるよう、環境変数による設定をサポートしています。

## バックエンド（ASP.NET Core）

### 設定ファイル構成

- `appsettings.json` - 基本設定（開発環境のデフォルト値）
- `appsettings.Development.json` - 開発環境固有の設定
- `appsettings.Production.json` - 本番環境設定（環境変数プレースホルダー）

### 環境変数一覧

| 環境変数名 | 説明 | デフォルト値 | 例 |
|-----------|------|-------------|-----|
| `DATABASE_CONNECTION_STRING` | データベース接続文字列 | `Data Source=ecshop.db` | `Data Source=/app/data/ecshop.db` |
| `JWT_SECRET_KEY` | JWT署名用秘密鍵 | 開発用キー | `your-production-secret-key` |
| `JWT_ISSUER` | JWTトークン発行者 | `ECShop.API` | `https://api.yourcompany.com` |
| `JWT_AUDIENCE` | JWTトークン対象者 | `ECShop.Client` | `https://app.yourcompany.com` |
| `JWT_EXPIRY_HOURS` | JWTトークン有効期限（時間） | `24` | `8` |
| `CORS_ALLOWED_ORIGINS` | CORS許可オリジン | `http://localhost:3000,http://localhost:8080` | `https://app.yourcompany.com,https://admin.yourcompany.com` |

### 設定方法

#### 開発環境
開発環境では環境変数を設定する必要はありません。`appsettings.json`と`appsettings.Development.json`のデフォルト値が使用されます。

#### 本番環境

**Docker環境の場合:**
```bash
docker run -e DATABASE_CONNECTION_STRING="Data Source=/app/data/ecshop.db" \
           -e JWT_SECRET_KEY="your-production-secret-key" \
           -e CORS_ALLOWED_ORIGINS="https://app.yourcompany.com" \
           your-ecshop-api-image
```

**Azure App Service の場合:**
アプリケーション設定で以下の環境変数を設定：
- `DATABASE_CONNECTION_STRING`
- `JWT_SECRET_KEY`
- `CORS_ALLOWED_ORIGINS`

**Linux/Windows サーバーの場合:**
```bash
# Linux
export DATABASE_CONNECTION_STRING="Data Source=/app/data/ecshop.db"
export JWT_SECRET_KEY="your-production-secret-key"
export CORS_ALLOWED_ORIGINS="https://app.yourcompany.com"

# Windows
set DATABASE_CONNECTION_STRING=Data Source=C:\app\data\ecshop.db
set JWT_SECRET_KEY=your-production-secret-key
set CORS_ALLOWED_ORIGINS=https://app.yourcompany.com
```

## フロントエンド（Vue.js）

### 環境ファイル構成

- `.env` - 開発環境用設定
- `.env.production` - 本番環境用設定

### 環境変数一覧

| 環境変数名 | 説明 | デフォルト値 | 例 |
|-----------|------|-------------|-----|
| `VUE_APP_API_BASE_URL` | APIベースURL | `http://localhost:5000/api` | `https://api.yourcompany.com/api` |

### 設定方法

#### 開発環境
`.env`ファイルが自動的に読み込まれます：
```
VUE_APP_API_BASE_URL=http://localhost:5000/api
```

#### 本番環境
`.env.production`ファイルを編集：
```
VUE_APP_API_BASE_URL=https://api.yourcompany.com/api
```

#### ビルド時の環境変数指定
```bash
# 本番ビルド時に環境変数を指定
VUE_APP_API_BASE_URL=https://api.yourcompany.com/api npm run build

# または.env.productionファイルを使用
npm run build
```

## デプロイメント例

### Docker Compose

```yaml
version: '3.8'
services:
  api:
    build: ./ECShop.API
    environment:
      - DATABASE_CONNECTION_STRING=Data Source=/app/data/ecshop.db
      - JWT_SECRET_KEY=your-production-secret-key
      - CORS_ALLOWED_ORIGINS=https://app.yourcompany.com
    ports:
      - "5000:80"
    volumes:
      - ./data:/app/data

  frontend:
    build: 
      context: ./frontend
      args:
        - VUE_APP_API_BASE_URL=https://api.yourcompany.com/api
    ports:
      - "3000:80"
    depends_on:
      - api
```

### Kubernetes

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ecshop-api
spec:
  replicas: 2
  selector:
    matchLabels:
      app: ecshop-api
  template:
    metadata:
      labels:
        app: ecshop-api
    spec:
      containers:
      - name: api
        image: ecshop-api:latest
        env:
        - name: DATABASE_CONNECTION_STRING
          value: "Data Source=/app/data/ecshop.db"
        - name: JWT_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: ecshop-secrets
              key: jwt-secret
        - name: CORS_ALLOWED_ORIGINS
          value: "https://app.yourcompany.com"
        ports:
        - containerPort: 80
```

## セキュリティ考慮事項

### バックエンド
- `JWT_SECRET_KEY`は十分に長く複雑な文字列を使用
- 本番環境では環境変数やシークレット管理サービスを使用
- データベース接続文字列に機密情報が含まれる場合は適切に保護

### フロントエンド
- `VUE_APP_`プレフィックスの環境変数はクライアントサイドに公開される
- 機密情報は含めない
- APIキーなどはバックエンド経由でアクセス

## トラブルシューティング

### よくある問題

1. **CORS エラー**
   - `CORS_ALLOWED_ORIGINS`にフロントエンドのURLが含まれているか確認
   - プロトコル（http/https）とポート番号が正確か確認

2. **API接続エラー**
   - `VUE_APP_API_BASE_URL`が正しく設定されているか確認
   - ネットワーク接続とファイアウォール設定を確認

3. **JWT認証エラー**
   - `JWT_SECRET_KEY`がフロントエンドとバックエンドで一致しているか確認
   - トークンの有効期限設定を確認

### デバッグ方法

**バックエンド:**
```csharp
// Program.cs で設定値を確認
var corsOrigins = builder.Configuration.GetSection("CorsSettings")["AllowedOrigins"];
Console.WriteLine($"CORS Origins: {corsOrigins}");
```

**フロントエンド:**
```javascript
// 環境変数の値を確認
console.log('API Base URL:', process.env.VUE_APP_API_BASE_URL);
```

## 参考資料

- [ASP.NET Core Configuration](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/)
- [Vue.js Environment Variables](https://cli.vuejs.org/guide/mode-and-env.html)
- [Docker Environment Variables](https://docs.docker.com/compose/environment-variables/)
