# ECShop お知らせ管理機能設計書

## 1. 機能概要

### 1.1 機能目的
サイト運営者が重要なお知らせやメンテナンス情報を投稿・管理し、ユーザーに効果的に情報を伝達する機能を提供する。

### 1.2 主要機能
- お知らせ一覧表示・検索・フィルタリング
- お知らせ詳細表示
- お知らせの作成・更新・削除（管理者のみ）
- カテゴリ別分類
- 公開・非公開管理
- 公開日時設定

### 1.3 対象ユーザー
- **一般ユーザー**: お知らせ閲覧・検索
- **管理者**: お知らせの全操作（CRUD）

### 1.4 学習目的
この機能は新人開発者の学習用サンプルとして設計されており、以下の要素を実践的に学習できます：
- **クエリパラメータ**: 検索・フィルタリング機能
- **管理者認証**: JWT認証 + 権限チェック
- **CRUD操作**: 作成・読取・更新・削除の全操作
- **フロントエンド連携**: Vue.jsとAPIの連携
- **Controllerベタ書き**: Service層を使わない直接実装

## 2. システム構成

### 2.1 アーキテクチャ図
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ AnnouncementList│    │AnnouncementsCtrl│    │  Announcement   │
│ AnnouncementForm│◄──►│                 │◄──►│    Entity       │
│AnnouncementDetail│    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │  ECShopContext  │    │   JWT認証       │
                       │                 │    │   管理者権限    │
                       └─────────────────┘    └─────────────────┘
```

### 2.2 処理フロー
```
1. お知らせ一覧表示
   ↓
2. 検索・フィルタリング（クエリパラメータ）
   ↓
3. お知らせ詳細表示
   ↓
4. 管理者ログイン（JWT認証）
   ↓
5. お知らせ作成・編集・削除
   ↓
6. 公開・非公開管理
```

## 3. データモデル

### 3.1 Announcement エンティティ
```csharp
public class Announcement
{
    public int Id { get; set; }                    // お知らせID（主キー）
    
    [Required]
    [MaxLength(200)]
    public string Title { get; set; }              // タイトル（必須、最大200文字）
    
    [Required]
    [MaxLength(2000)]
    public string Content { get; set; }            // 内容（必須、最大2000文字）
    
    [Required]
    [MaxLength(50)]
    public string Category { get; set; }           // カテゴリ（必須、最大50文字）
    
    public bool IsPublished { get; set; }          // 公開フラグ（デフォルト: false）
    
    [Required]
    public DateTime PublishDate { get; set; }      // 公開日（必須）
    
    public DateTime CreatedAt { get; set; }        // 作成日時
    public DateTime UpdatedAt { get; set; }        // 更新日時
}
```

### 3.2 お知らせ関連 DTO
```csharp
// お知らせ作成リクエスト
public class CreateAnnouncementRequest
{
    [Required]
    [MaxLength(200)]
    public string Title { get; set; }              // タイトル
    
    [Required]
    [MaxLength(2000)]
    public string Content { get; set; }            // 内容
    
    [Required]
    [MaxLength(50)]
    public string Category { get; set; }           // カテゴリ
    
    public bool IsPublished { get; set; }          // 公開フラグ
    
    [Required]
    public DateTime PublishDate { get; set; }      // 公開日
}

// お知らせ更新リクエスト
public class UpdateAnnouncementRequest
{
    [Required]
    [MaxLength(200)]
    public string Title { get; set; }              // タイトル
    
    [Required]
    [MaxLength(2000)]
    public string Content { get; set; }            // 内容
    
    [Required]
    [MaxLength(50)]
    public string Category { get; set; }           // カテゴリ
    
    public bool IsPublished { get; set; }          // 公開フラグ
    
    [Required]
    public DateTime PublishDate { get; set; }      // 公開日
}

// お知らせレスポンス
public class AnnouncementResponse
{
    public int Id { get; set; }                    // お知らせID
    public string Title { get; set; }              // タイトル
    public string Content { get; set; }            // 内容
    public string Category { get; set; }           // カテゴリ
    public bool IsPublished { get; set; }          // 公開フラグ
    public DateTime PublishDate { get; set; }      // 公開日
    public DateTime CreatedAt { get; set; }        // 作成日時
    public DateTime UpdatedAt { get; set; }        // 更新日時
}

// お知らせサマリーレスポンス（一覧用）
public class AnnouncementSummaryResponse
{
    public int Id { get; set; }                    // お知らせID
    public string Title { get; set; }              // タイトル
    public string Category { get; set; }           // カテゴリ
    public bool IsPublished { get; set; }          // 公開フラグ
    public DateTime PublishDate { get; set; }      // 公開日
    public DateTime CreatedAt { get; set; }        // 作成日時
}
```

### 3.3 カテゴリ定義
```csharp
// 固定カテゴリ（announcementService.jsで定義）
public static readonly string[] Categories = {
    "重要",
    "一般", 
    "メンテナンス",
    "キャンペーン",
    "システム",
    "その他"
};
```

## 4. API仕様

### 4.1 お知らせ一覧取得（クエリパラメータ対応）
- **エンドポイント**: `GET /api/announcements`
- **認証**: 不要
- **機能**: お知らせ一覧を検索・フィルタリング・ソートして取得

#### パラメータ
| パラメータ | 型 | 必須 | 説明 |
|-----------|---|------|------|
| category | string | × | カテゴリフィルタ |
| keyword | string | × | タイトル・内容での部分一致検索 |
| published | boolean | × | 公開状態フィルタ（管理者のみ有効） |
| fromDate | DateTime | × | 公開日の開始日 |
| toDate | DateTime | × | 公開日の終了日 |

#### リクエスト例
```
GET /api/announcements?category=重要&keyword=メンテナンス&published=true
```

#### レスポンス例 (200 OK)
```json
[
  {
    "id": 1,
    "title": "システムメンテナンスのお知らせ",
    "category": "重要",
    "isPublished": true,
    "publishDate": "2024-01-15T10:00:00Z",
    "createdAt": "2024-01-10T09:00:00Z"
  },
  {
    "id": 2,
    "title": "新機能リリースのお知らせ",
    "category": "一般",
    "isPublished": true,
    "publishDate": "2024-01-12T14:00:00Z",
    "createdAt": "2024-01-11T16:30:00Z"
  }
]
```

### 4.2 お知らせ詳細取得
- **エンドポイント**: `GET /api/announcements/{id}`
- **認証**: 不要
- **機能**: 指定IDのお知らせ詳細を取得

#### レスポンス例 (200 OK)
```json
{
  "id": 1,
  "title": "システムメンテナンスのお知らせ",
  "content": "2024年1月20日（土）午前2:00〜午前6:00の間、システムメンテナンスを実施いたします。\n\nメンテナンス中はサービスをご利用いただけません。\nご不便をおかけしますが、ご理解のほどよろしくお願いいたします。",
  "category": "重要",
  "isPublished": true,
  "publishDate": "2024-01-15T10:00:00Z",
  "createdAt": "2024-01-10T09:00:00Z",
  "updatedAt": "2024-01-10T09:00:00Z"
}
```

### 4.3 お知らせ作成
- **エンドポイント**: `POST /api/announcements`
- **認証**: 必要（管理者権限）
- **機能**: 新しいお知らせを作成

#### リクエスト例
```json
{
  "title": "新機能リリースのお知らせ",
  "content": "この度、新機能をリリースいたしました。\n\n主な機能：\n- 検索機能の改善\n- UI/UXの向上\n- パフォーマンスの最適化\n\nぜひご利用ください。",
  "category": "一般",
  "isPublished": true,
  "publishDate": "2024-01-20T10:00:00Z"
}
```

#### レスポンス例 (201 Created)
```json
{
  "id": 3,
  "title": "新機能リリースのお知らせ",
  "content": "この度、新機能をリリースいたしました。\n\n主な機能：\n- 検索機能の改善\n- UI/UXの向上\n- パフォーマンスの最適化\n\nぜひご利用ください。",
  "category": "一般",
  "isPublished": true,
  "publishDate": "2024-01-20T10:00:00Z",
  "createdAt": "2024-01-18T15:30:00Z",
  "updatedAt": "2024-01-18T15:30:00Z"
}
```

### 4.4 お知らせ更新
- **エンドポイント**: `PUT /api/announcements/{id}`
- **認証**: 必要（管理者権限）
- **機能**: 指定IDのお知らせを更新

#### レスポンス (204 No Content)

### 4.5 お知らせ削除
- **エンドポイント**: `DELETE /api/announcements/{id}`
- **認証**: 必要（管理者権限）
- **機能**: 指定IDのお知らせを削除

#### レスポンス (204 No Content)

## 5. Controller・Action別処理設計

### 5.1 AnnouncementsController

#### GET /api/announcements (GetAnnouncements Action)
**処理概要**: お知らせ一覧を検索・フィルタリング・ソートして取得

**学習ポイント**: クエリパラメータの処理方法

**処理フロー**:
1. **クエリパラメータ取得**: 
   - `[FromQuery]`属性でcategory、keyword、published、fromDate、toDateを取得
   - 各パラメータはnull許容型で定義
2. **ログ出力**: 
   - `_logger.LogInformation`で処理開始をログ出力
   - パラメータ値も含めて記録
3. **基本クエリ作成**: 
   - `_context.Announcements.AsQueryable()`でクエリを初期化
4. **カテゴリフィルタ適用**:
   - `!string.IsNullOrEmpty(category)`でパラメータ存在チェック
   - `query.Where(a => a.Category.ToLower() == category.ToLower())`で大文字小文字を無視して比較
5. **キーワード検索適用**:
   - `!string.IsNullOrEmpty(keyword)`でパラメータ存在チェック
   - `keyword.ToLower()`で小文字に変換
   - `query.Where(a => a.Title.ToLower().Contains(lowerKeyword) || a.Content.ToLower().Contains(lowerKeyword))`でタイトルまたは内容に部分一致
6. **公開状態フィルタ適用**:
   - `published.HasValue`でパラメータ存在チェック
   - `query.Where(a => a.IsPublished == published.Value)`で公開状態をフィルタ
7. **日付範囲フィルタ適用**:
   - `fromDate.HasValue`と`toDate.HasValue`で各パラメータ存在チェック
   - `query.Where(a => a.PublishDate >= fromDate.Value)`で開始日以降をフィルタ
   - `query.Where(a => a.PublishDate <= toDate.Value)`で終了日以前をフィルタ
8. **ソート処理**: 
   - `query.OrderByDescending(a => a.PublishDate)`で公開日降順ソート
9. **データベース実行**: 
   - `await query.ToListAsync()`でクエリを実行してリストを取得
10. **レスポンス変換**: 
    - `announcements.Select()`でAnnouncementSummaryResponse形式に変換
    - 各プロパティを個別にマッピング
11. **JSON返却**: 
    - `Ok(response)`で200 OKステータスとJSONデータを返却

**エラー処理**: 
- try-catch文で例外をキャッチ
- `_logger.LogError`でエラーログ出力
- `StatusCode(500, "お知らせの取得に失敗しました")`で500エラーを返却

#### GET /api/announcements/{id} (GetAnnouncement Action)
**処理概要**: 指定IDのお知らせ詳細を取得

**学習ポイント**: URLパラメータの処理とエンティティ検索

**処理フロー**:
1. **URLパラメータ取得**: 
   - メソッド引数`int id`で自動的にルートパラメータを取得
2. **ID検証**: 
   - `if (id <= 0)`で無効なIDをチェック
   - `BadRequest("無効なお知らせIDです")`で400エラーを返却
3. **データベース検索**: 
   - `await _context.Announcements.FirstOrDefaultAsync(a => a.Id == id)`で指定IDのお知らせを検索
4. **存在チェック**: 
   - `if (announcement == null)`で検索結果をチェック
   - `NotFound("お知らせが見つかりません")`で404エラーを返却
5. **レスポンス変換**: 
   - `new AnnouncementResponse`でレスポンスオブジェクトを作成
   - 各プロパティを個別にマッピング
6. **JSON返却**: 
   - `Ok(response)`で200 OKステータスとJSONデータを返却

**エラー処理**: 
- try-catch文で例外をキャッチ
- `_logger.LogError`でエラーログ出力
- `StatusCode(500, "お知らせの取得に失敗しました")`で500エラーを返却

#### POST /api/announcements (CreateAnnouncement Action)
**処理概要**: 新しいお知らせを作成（管理者権限必要）

**学習ポイント**: JWT認証・管理者権限チェック・データ作成

**処理フロー**:
1. **JWT解析**: 
   - `HttpContext.User.FindFirst(ClaimTypes.NameIdentifier)`でJWTトークンからユーザーIDクレームを取得
2. **クレーム検証**: 
   - `userIdClaim == null`でクレーム存在チェック
   - `!int.TryParse(userIdClaim.Value, out int userId)`で整数変換チェック
   - `Unauthorized("認証情報が無効です")`で401エラーを返却
3. **管理者権限チェック**: 
   - `await _context.Users.FirstOrDefaultAsync(u => u.Id == userId)`でユーザー情報を取得
   - `user == null || !user.IsAdmin`で管理者権限をチェック
   - `Forbid("管理者権限が必要です")`で403エラーを返却
4. **リクエストボディバリデーション**: 
   - `string.IsNullOrWhiteSpace(request.Title)`でタイトル必須チェック
   - `string.IsNullOrWhiteSpace(request.Content)`で内容必須チェック
   - `string.IsNullOrWhiteSpace(request.Category)`でカテゴリ必須チェック
   - `BadRequest("エラーメッセージ")`で400エラーを返却
5. **エンティティ作成**: 
   - `new Announcement`でエンティティオブジェクトを作成
   - `request.Title.Trim()`で前後の空白を除去して設定
   - `DateTime.UtcNow`で現在日時をCreatedAt、UpdatedAtに設定
6. **データベース保存**: 
   - `_context.Announcements.Add(announcement)`でコンテキストに追加
   - `await _context.SaveChangesAsync()`でデータベースに保存
7. **レスポンス作成**: 
   - `new AnnouncementResponse`でレスポンスオブジェクトを作成
   - 保存後のエンティティから各プロパティをマッピング
8. **201 Created返却**: 
   - `CreatedAtAction(nameof(GetAnnouncement), new { id = announcement.Id }, response)`で201ステータスとLocationヘッダー、JSONデータを返却

**エラー処理**: 
- try-catch文で例外をキャッチ
- `_logger.LogError`でエラーログ出力
- `StatusCode(500, "お知らせの作成に失敗しました")`で500エラーを返却

#### PUT /api/announcements/{id} (UpdateAnnouncement Action)
**処理概要**: 指定IDのお知らせを更新（管理者権限必要）

**学習ポイント**: データ更新処理

**処理フロー**:
1. **JWT解析・管理者権限チェック**: CreateAnnouncementと同様の処理
2. **URLパラメータ検証**: GetAnnouncementと同様の処理
3. **お知らせ検索**: 
   - `await _context.Announcements.FirstOrDefaultAsync(a => a.Id == id)`で更新対象を検索
   - `NotFound("お知らせが見つかりません")`で404エラーを返却
4. **リクエストボディバリデーション**: CreateAnnouncementと同様の処理
5. **エンティティ更新**: 
   - 既存エンティティのプロパティを新しい値で更新
   - `announcement.Title = request.Title.Trim()`で各プロパティを設定
   - `announcement.UpdatedAt = DateTime.UtcNow`で更新日時を設定
6. **データベース保存**: 
   - `await _context.SaveChangesAsync()`で変更を保存
7. **204 No Content返却**: 
   - `NoContent()`で204ステータスを返却（レスポンスボディなし）

#### DELETE /api/announcements/{id} (DeleteAnnouncement Action)
**処理概要**: 指定IDのお知らせを削除（管理者権限必要）

**学習ポイント**: データ削除処理

**処理フロー**:
1. **JWT解析・管理者権限チェック**: CreateAnnouncementと同様の処理
2. **URLパラメータ検証・お知らせ検索**: UpdateAnnouncementと同様の処理
3. **エンティティ削除**: 
   - `_context.Announcements.Remove(announcement)`でコンテキストから削除
4. **データベース保存**: 
   - `await _context.SaveChangesAsync()`で変更を保存
5. **204 No Content返却**: 
   - `NoContent()`で204ステータスを返却

## 6. フロントエンド設計

### 6.1 Vue.js コンポーネント構成

#### AnnouncementList.vue
**役割**: お知らせ一覧表示のメインコンポーネント

**学習ポイント**: 
- クエリパラメータを使った検索・フィルタリング
- 管理者権限による表示制御
- デバウンス処理による検索最適化

**主要機能**:
- お知らせ一覧取得・表示
- 検索・フィルタリング（キーワード、カテゴリ、公開状態）
- 管理者向け操作（作成・編集・削除）
- ページネーション（将来実装）

**重要メソッド**:
```javascript
// お知らせ一覧を読み込む
async loadAnnouncements() {
  this.loading = true;
  this.error = null;
  
  try {
    // 1. announcementService.getAnnouncementsを呼び出し
    // 2. filtersオブジェクトをパラメータとして渡す
    // 3. クエリパラメータが自動的に構築される
    this.announcements = await announcementService.getAnnouncements(this.filters);
  } catch (error) {
    console.error('お知らせ一覧の読み込みに失敗しました:', error);
    this.error = error.message;
  } finally {
    this.loading = false;
  }
}

// 検索のデバウンス処理
debounceSearch() {
  // 既存のタイマーをクリア
  if (this.searchTimeout) {
    clearTimeout(this.searchTimeout);
  }
  
  // 300ms後に検索実行
  this.searchTimeout = setTimeout(() => {
    this.applyFilters();
  }, 300);
}
```

#### AnnouncementDetail.vue
**役割**: お知らせ詳細表示コンポーネント

**学習ポイント**: 
- モーダル表示の実装
- propsを使ったデータ受け渡し
- HTMLエスケープ処理

**主要機能**:
- お知らせ詳細情報表示
- 改行文字の適切な表示
- モーダル形式での表示
- ESCキーでの閉じる機能

**重要メソッド**:
```javascript
// お知らせ詳細を読み込む
async loadAnnouncement() {
  this.loading = true;
  this.error = null;
  
  try {
    // 1. announcementService.getAnnouncementを呼び出し
    // 2. propsで受け取ったannouncementIdを渡す
    // 3. APIから詳細データを取得
    this.announcement = await announcementService.getAnnouncement(this.announcementId);
  } catch (error) {
    console.error('お知らせ詳細の読み込みに失敗しました:', error);
    this.error = error.message;
  } finally {
    this.loading = false;
  }
}
```

#### AnnouncementForm.vue
**役割**: お知らせ作成・編集フォームコンポーネント

**学習ポイント**: 
- フォームバリデーション
- 作成・編集の共通化
- 日付フォーマット処理

**主要機能**:
- お知らせ作成・編集フォーム
- リアルタイムバリデーション
- 文字数カウント表示
- 日付・時刻入力

**重要メソッド**:
```javascript
// フォーム送信処理
async handleSubmit() {
  // 1. バリデーション実行
  if (!this.validateForm()) {
    return;
  }

  this.loading = true;
  this.error = null;

  try {
    // 2. 送信データを準備
    const announcementData = {
      title: this.form.title.trim(),
      content: this.form.content.trim(),
      category: this.form.category,
      isPublished: this.form.isPublished,
      publishDate: new Date(this.form.publishDate)
    };

    if (this.isEditing) {
      // 3a. 編集モード：updateAnnouncementを呼び出し
      await announcementService.updateAnnouncement(this.announcement.id, announcementData);
    } else {
      // 3b. 新規作成モード：createAnnouncementを呼び出し
      await announcementService.createAnnouncement(announcementData);
    }

    // 4. 成功時：親コンポーネントに通知
    this.$emit('saved');
  } catch (error) {
    console.error('お知らせの保存に失敗しました:', error);
    this.error = error.message;
  } finally {
    this.loading = false;
  }
}
```

### 6.2 announcementService.js
**役割**: お知らせAPI通信サービス

**学習ポイント**: 
- RESTful APIの呼び出し
- 認証ヘッダーの付与
- エラーハンドリング

**主要機能**:
- お知らせCRUD操作のAPI呼び出し
- クエリパラメータの構築
- 認証・認可エラーの処理
- データバリデーション

**重要メソッド**:
```javascript
// お知らせ一覧取得（クエリパラメータ対応）
async getAnnouncements(filters = {}) {
  try {
    // 1. クエリパラメータを構築
    const params = new URLSearchParams();
    
    if (filters.category) {
      params.append('category', filters.category);
    }
    
    if (filters.keyword) {
      params.append('keyword', filters.keyword);
    }
    
    if (filters.published !== undefined) {
      params.append('published', filters.published.toString());
    }

    // 2. URLを構築
    const url = params.toString() ? `${this.baseURL}?${params}` : this.baseURL;

    // 3. APIリクエスト送信
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    // 4. エラーハンドリング
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: お知らせの取得に失敗しました`);
    }

    // 5. レスポンスをJSONで返却
    return await response.json();
  } catch (error) {
    console.error('お知らせ一覧取得エラー:', error);
    throw new Error('お知らせの取得に失敗しました。ネットワーク接続を確認してください。');
  }
}
```

## 7. エラーハンドリング

### 7.1 バックエンドエラー処理

#### 統一エラーレスポンス
```csharp
// GlobalExceptionMiddlewareで統一的に処理
try
{
    await _next(context);
}
catch (ArgumentException ex)
{
    // バリデーションエラー → 400 Bad Request
    await HandleExceptionAsync(context, ex, HttpStatusCode.BadRequest);
}
catch (UnauthorizedAccessException ex)
{
    // 認証エラー → 401 Unauthorized
    await HandleExceptionAsync(context, ex, HttpStatusCode.Unauthorized);
}
catch (Exception ex)
{
    // その他のエラー → 500 Internal Server Error
    await HandleExceptionAsync(context, ex, HttpStatusCode.InternalServerError);
}
```

#### エラーメッセージ定数
```csharp
public static class ErrorMessages
{
    public static class Announcement
    {
