# ECShop システム全体設計書

## 1. システム概要

### 1.1 プロジェクト概要
- **プロジェクト名**: ECShop
- **目的**: フルスタックECサイトのサンプル実装
- **アーキテクチャ**: C# ASP.NET Core 8.0 Web API + Vue.js 3 フロントエンド
- **データベース**: SQLite + Entity Framework Core
- **認証**: JWT Bearer Token
- **UI**: Bootstrap 5 + Font Awesome

### 1.2 システム構成図
```
┌─────────────────┐    HTTP/HTTPS    ┌─────────────────┐
│   Vue.js 3      │ ◄──────────────► │  ASP.NET Core   │
│   Frontend      │                  │   Web API       │
│                 │                  │                 │
│ - Bootstrap 5   │                  │ - Controllers   │
│ - Axios         │                  │ - Services      │
│ - Vue Router    │                  │ - Repositories  │
└─────────────────┘                  └─────────────────┘
                                               │
                                               │ EF Core
                                               ▼
                                     ┌─────────────────┐
                                     │   SQLite DB     │
                                     │                 │
                                     │ - Users         │
                                     │ - Products      │
                                     │ - Orders        │
                                     │ - OrderItems    │
                                     └─────────────────┘
```

## 2. アーキテクチャ設計

### 2.1 レイヤー構成

#### バックエンド（ASP.NET Core）
```
┌─────────────────────────────────────┐
│           Presentation Layer        │
│         (Controllers)               │
├─────────────────────────────────────┤
│           Business Layer            │
│         (Services)                  │
├─────────────────────────────────────┤
│           Data Access Layer         │
│      (Repositories + EF Core)       │
├─────────────────────────────────────┤
│           Database Layer            │
│           (SQLite)                  │
└─────────────────────────────────────┘
```

#### フロントエンド（Vue.js）
```
┌─────────────────────────────────────┐
│         Presentation Layer          │
│        (Vue Components)             │
├─────────────────────────────────────┤
│         Service Layer               │
│       (API Services)                │
├─────────────────────────────────────┤
│         State Management            │
│      (Local State + Storage)        │
└─────────────────────────────────────┘
```

### 2.2 技術スタック

#### バックエンド
- **フレームワーク**: ASP.NET Core 8.0
- **ORM**: Entity Framework Core
- **データベース**: SQLite
- **認証**: JWT Bearer Token
- **パスワードハッシュ**: BCrypt.Net
- **ログ**: Microsoft.Extensions.Logging
- **API文書**: Swagger/OpenAPI

#### フロントエンド
- **フレームワーク**: Vue.js 3
- **UI**: Bootstrap 5
- **アイコン**: Bootstrap Icons
- **HTTP クライアント**: Axios
- **ビルドツール**: Vue CLI
- **状態管理**: Local State (将来的にVuex/Pinia検討)

## 3. データフロー

### 3.1 認証フロー
```
User → LoginForm → AuthService → AuthController → JWT Token → LocalStorage
```

### 3.2 商品表示フロー
```
User → ProductList → API Service → ProductsController → ProductService → ProductRepository → Database
```

### 3.3 注文フロー
```
User → CheckoutForm → OrderService → OrdersController → Database → Stock Update
```

## 4. セキュリティ設計

### 4.1 認証・認可
- **認証方式**: JWT Bearer Token
- **トークン有効期限**: 24時間（設定可能）
- **権限管理**: Role-based (User/Admin)
- **パスワード**: BCrypt ハッシュ化

### 4.2 API セキュリティ
- **CORS**: 適切な設定
- **HTTPS**: 本番環境では必須
- **入力検証**: Model Validation + Custom Validation
- **SQLインジェクション対策**: Entity Framework使用

### 4.3 フロントエンド セキュリティ
- **XSS対策**: Vue.jsの自動エスケープ
- **トークン管理**: localStorage使用（将来的にhttpOnlyクッキー検討）
- **入力検証**: クライアント側 + サーバー側

## 5. パフォーマンス設計

### 5.1 データベース最適化
- **インデックス**: 検索対象フィールドに設定
- **N+1問題対策**: Include使用
- **ページネーション**: 大量データ対応

### 5.2 API最適化
- **非同期処理**: async/await使用
- **キャッシュ**: 必要に応じて実装
- **圧縮**: gzip圧縮有効化

### 5.3 フロントエンド最適化
- **遅延ローディング**: 大きなコンポーネント
- **バンドルサイズ**: 最適化
- **画像最適化**: 適切なサイズ・形式

## 6. エラーハンドリング

### 6.1 バックエンド
- **グローバル例外ハンドラ**: GlobalExceptionMiddleware
- **ログ出力**: 構造化ログ
- **エラーレスポンス**: 統一形式

### 6.2 フロントエンド
- **API エラー**: 統一的なエラーハンドリング
- **ユーザーフレンドリー**: 分かりやすいエラーメッセージ
- **リトライ機能**: ネットワークエラー対応

## 7. 開発・運用

### 7.1 開発環境
- **IDE**: Visual Studio / VS Code
- **デバッグ**: Chrome DevTools, Visual Studio Debugger
- **API テスト**: Swagger UI, Postman

### 7.2 テスト戦略
- **単体テスト**: xUnit (C#), Jest (Vue.js)
- **統合テスト**: ASP.NET Core Test Host
- **E2Eテスト**: 将来的にCypress検討

### 7.3 デプロイメント
- **開発**: IIS Express + Vue CLI Dev Server
- **本番**: IIS / Docker + Nginx (検討)
- **データベース**: SQLite (開発), SQL Server (本番検討)

## 8. 制約事項・注意点

### 8.1 SQLite制限
- **decimal型集計**: メモリ上で処理（ToListAsync後にSum）
- **decimal型ORDER BY**: メモリ上でソート
- **大文字小文字**: ToLower()で統一

### 8.2 スケーラビリティ
- **同時接続数**: SQLiteの制限を考慮
- **ファイルアップロード**: 現在未実装
- **リアルタイム通信**: SignalR未実装

### 8.3 セキュリティ制限
- **トークンリフレッシュ**: 未実装
- **レート制限**: 未実装
- **監査ログ**: 未実装

## 9. 今後の拡張予定

### 9.1 機能拡張
- **商品カテゴリ**: 分類機能
- **レビュー・評価**: ユーザーフィードバック
- **在庫アラート**: 自動通知
- **クーポン・割引**: プロモーション機能

### 9.2 技術的改善
- **キャッシュ**: Redis導入
- **検索**: Elasticsearch導入
- **ファイル管理**: Azure Blob Storage
- **監視**: Application Insights

### 9.3 運用改善
- **CI/CD**: GitHub Actions
- **コンテナ化**: Docker
- **ログ管理**: 集約ログシステム
- **パフォーマンス監視**: APM ツール
