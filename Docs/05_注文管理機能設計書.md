# ECShop 注文管理機能設計書

## 1. 機能概要

### 1.1 機能目的
ユーザーの注文処理、注文履歴管理、注文ステータス管理を提供し、ECサイトの注文業務を効率化する。

### 1.2 主要機能
- 注文作成・決済処理
- 注文一覧・詳細表示
- 注文ステータス管理
- 在庫連動処理
- 配送情報管理
- 注文履歴管理

### 1.3 対象ユーザー
- **一般ユーザー**: 注文作成・履歴確認
- **管理者**: 全注文管理・ステータス更新

## 2. システム構成

### 2.1 アーキテクチャ図
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  CheckoutForm   │    │ OrdersController│    │   Order Entity  │
│  OrderHistory   │◄──►│                 │◄──►│   OrderItem     │
│  OrderDetails   │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │ OrderService    │    │ ProductService  │
                       │                 │◄──►│ (在庫管理)      │
                       └─────────────────┘    └─────────────────┘
```

### 2.2 注文処理フロー
```
1. カート商品選択
   ↓
2. 配送情報入力
   ↓
3. 注文内容確認
   ↓
4. 在庫チェック
   ↓
5. 注文作成・在庫減算
   ↓
6. 注文確認メール（将来実装）
   ↓
7. 注文ステータス更新
```

## 3. データモデル

### 3.1 Order エンティティ
```csharp
public class Order
{
    public int Id { get; set; }                    // 注文ID（主キー）
    
    [Required]
    public int UserId { get; set; }                // ユーザーID（外部キー）
    
    [Required]
    public DateTime OrderDate { get; set; }        // 注文日時
    
    [Required]
    public OrderStatus Status { get; set; }        // 注文ステータス
    
    [Required]
    [Range(0, double.MaxValue)]
    public decimal TotalAmount { get; set; }       // 合計金額
    
    // 配送情報
    [Required]
    [MaxLength(100)]
    public string ShippingName { get; set; }       // 配送先氏名
    
    [Required]
    [MaxLength(10)]
    public string ShippingPostalCode { get; set; } // 郵便番号
    
    [Required]
    [MaxLength(50)]
    public string ShippingPrefecture { get; set; } // 都道府県
    
    [Required]
    [MaxLength(100)]
    public string ShippingCity { get; set; }       // 市区町村
    
    [Required]
    [MaxLength(200)]
    public string ShippingAddressLine { get; set; }// 住所
    
    [MaxLength(20)]
    public string? ShippingPhone { get; set; }     // 電話番号
    
    [MaxLength(500)]
    public string? Notes { get; set; }             // 備考
    
    public DateTime CreatedAt { get; set; }        // 作成日時
    public DateTime UpdatedAt { get; set; }        // 更新日時
    
    // ナビゲーションプロパティ
    public User User { get; set; } = null!;
    public ICollection<OrderItem> OrderItems { get; set; } = new List<OrderItem>();
}
```

### 3.2 OrderItem エンティティ
```csharp
public class OrderItem
{
    public int Id { get; set; }                    // 注文明細ID（主キー）
    
    [Required]
    public int OrderId { get; set; }               // 注文ID（外部キー）
    
    [Required]
    public int ProductId { get; set; }             // 商品ID（外部キー）
    
    [Required]
    [Range(1, int.MaxValue)]
    public int Quantity { get; set; }              // 数量
    
    [Required]
    [Range(0, double.MaxValue)]
    public decimal Price { get; set; }             // 単価（注文時点の価格）
    
    [Required]
    [MaxLength(100)]
    public string ProductName { get; set; }        // 商品名（注文時点）
    
    [MaxLength(500)]
    public string ProductDescription { get; set; } // 商品説明（注文時点）
    
    // ナビゲーションプロパティ
    public Order Order { get; set; } = null!;
    public Product Product { get; set; } = null!;
}
```

### 3.3 OrderStatus 列挙型
```csharp
public enum OrderStatus
{
    Pending = 0,      // 注文確認中
    Confirmed = 1,    // 注文確定
    Processing = 2,   // 処理中
    Shipped = 3,      // 発送済み
    Delivered = 4,    // 配送完了
    Cancelled = 5     // キャンセル
}
```

### 3.4 注文関連 DTO
```csharp
// 注文作成リクエスト
public class CreateOrderRequest
{
    [Required]
    public List<OrderItemRequest> Items { get; set; } = new();
    
    [Required]
    [MaxLength(100)]
    public string ShippingName { get; set; }       // 配送先氏名
    
    [Required]
    [MaxLength(10)]
    public string ShippingPostalCode { get; set; } // 郵便番号
    
    [Required]
    [MaxLength(50)]
    public string ShippingPrefecture { get; set; } // 都道府県
    
    [Required]
    [MaxLength(100)]
    public string ShippingCity { get; set; }       // 市区町村
    
    [Required]
    [MaxLength(200)]
    public string ShippingAddressLine { get; set; }// 住所
    
    [MaxLength(20)]
    public string? ShippingPhone { get; set; }     // 電話番号
    
    [MaxLength(500)]
    public string? Notes { get; set; }             // 備考
}

// 注文明細リクエスト
public class OrderItemRequest
{
    [Required]
    [Range(1, int.MaxValue)]
    public int ProductId { get; set; }             // 商品ID
    
    [Required]
    [Range(1, int.MaxValue)]
    public int Quantity { get; set; }              // 数量
}

// 注文サマリーレスポンス
public class OrderSummaryResponse
{
    public int Id { get; set; }                    // 注文ID
    public DateTime OrderDate { get; set; }        // 注文日時
    public int Status { get; set; }                // 注文ステータス
    public string StatusText { get; set; }         // ステータステキスト
    public decimal TotalAmount { get; set; }       // 合計金額
    public int ItemCount { get; set; }             // 商品点数
}

// 注文詳細レスポンス
public class OrderResponse
{
    public int Id { get; set; }                    // 注文ID
    public int UserId { get; set; }                // ユーザーID
    public DateTime OrderDate { get; set; }        // 注文日時
    public int Status { get; set; }                // 注文ステータス
    public string StatusText { get; set; }         // ステータステキスト
    public decimal TotalAmount { get; set; }       // 合計金額
    
    // 配送情報
    public string ShippingName { get; set; }       // 配送先氏名
    public string ShippingPostalCode { get; set; } // 郵便番号
    public string ShippingPrefecture { get; set; } // 都道府県
    public string ShippingCity { get; set; }       // 市区町村
    public string ShippingAddressLine { get; set; }// 住所
    public string? ShippingPhone { get; set; }     // 電話番号
    public string? Notes { get; set; }             // 備考
    
    public DateTime CreatedAt { get; set; }        // 作成日時
    public DateTime UpdatedAt { get; set; }        // 更新日時
    
    public List<OrderItemResponse> Items { get; set; } = new();
}

// 注文明細レスポンス
public class OrderItemResponse
{
    public int Id { get; set; }                    // 注文明細ID
    public int ProductId { get; set; }             // 商品ID
    public string ProductName { get; set; }        // 商品名
    public string ProductDescription { get; set; } // 商品説明
    public int Quantity { get; set; }              // 数量
    public decimal Price { get; set; }             // 単価
    public decimal Subtotal { get; set; }          // 小計
}

// 注文ステータス更新リクエスト
public class UpdateOrderStatusRequest
{
    [Required]
    [Range(0, 5)]
    public OrderStatus Status { get; set; }        // 新しいステータス
}
```

## 4. API仕様

### 4.1 注文一覧取得
- **エンドポイント**: `GET /api/orders`
- **認証**: 必要
- **機能**: 現在のユーザーの注文一覧を取得

#### レスポンス例 (200 OK)
```json
[
  {
    "id": 1,
    "orderDate": "2024-01-01T10:00:00Z",
    "status": 0,
    "statusText": "注文確認中",
    "totalAmount": 2500.00,
    "itemCount": 3
  },
  {
    "id": 2,
    "orderDate": "2024-01-02T15:30:00Z",
    "status": 3,
    "statusText": "発送済み",
    "totalAmount": 1200.00,
    "itemCount": 1
  }
]
```

#### 処理フロー
1. JWT トークンからユーザーID取得
2. ユーザーの注文一覧を日付降順で取得
3. OrderSummaryResponse 形式に変換
4. JSON形式で返却

### 4.2 注文詳細取得
- **エンドポイント**: `GET /api/orders/{id}`
- **認証**: 必要
- **機能**: 指定IDの注文詳細を取得

#### レスポンス例 (200 OK)
```json
{
  "id": 1,
  "userId": 1,
  "orderDate": "2024-01-01T10:00:00Z",
  "status": 0,
  "statusText": "注文確認中",
  "totalAmount": 2500.00,
  "shippingName": "田中太郎",
  "shippingPostalCode": "123-4567",
  "shippingPrefecture": "東京都",
  "shippingCity": "渋谷区",
  "shippingAddressLine": "1-1-1 マンション101",
  "shippingPhone": "090-1234-5678",
  "notes": "午前中配送希望",
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z",
  "items": [
    {
      "id": 1,
      "productId": 1,
      "productName": "ノートパソコン",
      "productDescription": "高性能ノートPC",
      "quantity": 1,
      "price": 2000.00,
      "subtotal": 2000.00
    },
    {
      "id": 2,
      "productId": 2,
      "productName": "マウス",
      "productDescription": "ワイヤレスマウス",
      "quantity": 1,
      "price": 500.00,
      "subtotal": 500.00
    }
  ]
}
```

#### 処理フロー
1. JWT トークンからユーザーID取得
2. 注文IDとユーザーIDで注文検索
3. 注文明細を含めて取得（Include使用）
4. OrderResponse 形式に変換
5. JSON形式で返却

### 4.3 注文作成
- **エンドポイント**: `POST /api/orders`
- **認証**: 必要
- **機能**: 新しい注文を作成

#### リクエスト例
```json
{
  "items": [
    {
      "productId": 1,
      "quantity": 1
    },
    {
      "productId": 2,
      "quantity": 2
    }
  ],
  "shippingName": "田中太郎",
  "shippingPostalCode": "123-4567",
  "shippingPrefecture": "東京都",
  "shippingCity": "渋谷区",
  "shippingAddressLine": "1-1-1 マンション101",
  "shippingPhone": "090-1234-5678",
  "notes": "午前中配送希望"
}
```

#### レスポンス例 (201 Created)
```json
{
  "id": 1,
  "userId": 1,
  "orderDate": "2024-01-01T10:00:00Z",
  "status": 0,
  "statusText": "注文確認中",
  "totalAmount": 2500.00,
  "shippingName": "田中太郎",
  "shippingPostalCode": "123-4567",
  "shippingPrefecture": "東京都",
  "shippingCity": "渋谷区",
  "shippingAddressLine": "1-1-1 マンション101",
  "shippingPhone": "090-1234-5678",
  "notes": "午前中配送希望",
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z",
  "items": [...]
}
```

#### 処理フロー
1. JWT トークンからユーザーID取得
2. リクエストボディのバリデーション
3. 各商品の存在確認・在庫チェック
4. 合計金額計算
5. 注文エンティティ作成
6. 注文明細エンティティ作成
7. 商品在庫減算
8. データベース保存（トランザクション）
9. OrderResponse 形式に変換
10. 201 Created で返却

### 4.4 注文ステータス更新
- **エンドポイント**: `PUT /api/orders/{id}/status`
- **認証**: 必要
- **機能**: 注文のステータスを更新（ユーザー自身の注文のみ）

#### リクエスト例
```json
{
  "status": 5
}
```

#### レスポンス (204 No Content)

#### 処理フロー
1. JWT トークンからユーザーID取得
2. 注文IDとユーザーIDで注文検索
3. ステータス更新
4. UpdatedAt 更新
5. データベース保存
6. 204 No Content で返却

## 5. ビジネスロジック

## 5. Controller・Action別処理設計

### 5.1 OrdersController

#### GET /api/orders (GetOrders Action)
**処理概要**: 現在のユーザーの注文一覧を取得

**リクエスト**
- **ヘッダー**: `Authorization: Bearer {JWT_TOKEN}`

**レスポンス** (200 OK)
```json
[
  {
    "id": 1,
    "orderDate": "2024-01-01T10:00:00Z",
    "status": 0,
    "statusText": "注文確認中",
    "totalAmount": 2500.00,
    "itemCount": 3
  },
  {
    "id": 2,
    "orderDate": "2024-01-02T15:30:00Z",
    "status": 3,
    "statusText": "発送済み",
    "totalAmount": 1200.00,
    "itemCount": 1
  }
]
```

**処理フロー**:
1. **JWT解析**: Authorizationヘッダーからトークンを取得
2. **ユーザーID取得**: JWTトークンからNameIdentifierクレーム（ユーザーID）を取得
3. **注文検索**: ECShopContextを使用してOrdersテーブルから該当ユーザーの注文を検索
4. **関連データ取得**: Include()を使用してOrderItemsも同時に取得
5. **ソート**: OrderDateで降順ソート（最新の注文が先頭）
6. **データ変換**: 各注文をOrderSummaryResponse形式に変換
7. **ステータステキスト設定**: OrderStatus列挙型を日本語テキストに変換
8. **JSON変換**: 注文一覧をJSON配列として返却

**エラー処理**: 
- 認証エラー（トークン無効・期限切れ） → 401 Unauthorized

#### GET /api/orders/{id} (GetOrder Action)
**処理概要**: 指定IDの注文詳細を取得

**リクエスト**
- **ヘッダー**: `Authorization: Bearer {JWT_TOKEN}`
- **URLパラメータ**:
  - `id` (int, 必須): 注文ID

**レスポンス** (200 OK)
```json
{
  "id": 1,
  "userId": 1,
  "orderDate": "2024-01-01T10:00:00Z",
  "status": 0,
  "statusText": "注文確認中",
  "totalAmount": 2500.00,
  "shippingName": "田中太郎",
  "shippingPostalCode": "123-4567",
  "shippingPrefecture": "東京都",
  "shippingCity": "渋谷区",
  "shippingAddressLine": "1-1-1 マンション101",
  "shippingPhone": "090-1234-5678",
  "notes": "午前中配送希望",
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z",
  "items": [
    {
      "id": 1,
      "productId": 1,
      "productName": "ノートパソコン",
      "productDescription": "高性能ノートPC",
      "quantity": 1,
      "price": 2000.00,
      "subtotal": 2000.00
    }
  ]
}
```

**処理フロー**:
1. **JWT解析**: Authorizationヘッダーからトークンを取得
2. **ユーザーID取得**: JWTトークンからNameIdentifierクレーム（ユーザーID）を取得
3. **URLパラメータ取得**: ルートパラメータから注文IDを取得
4. **注文検索**: ECShopContextを使用してOrdersテーブルから指定IDかつ該当ユーザーの注文を検索
5. **関連データ取得**: Include()を使用してOrderItems、Productも同時に取得
6. **存在チェック**: 注文が見つからない場合は404エラー
7. **データ変換**: OrderResponse形式に変換
8. **小計計算**: 各注文明細の小計（価格×数量）を計算
9. **JSON変換**: 注文詳細をJSON形式で返却

**エラー処理**: 
- 注文不存在（他ユーザーの注文含む） → 404 Not Found
- 認証エラー → 401 Unauthorized

#### POST /api/orders (CreateOrder Action)
**処理概要**: 新しい注文を作成

**リクエスト**
- **ヘッダー**: `Authorization: Bearer {JWT_TOKEN}`
- **リクエストボディ**:
```json
{
  "items": [
    {
      "productId": 1,
      "quantity": 1
    },
    {
      "productId": 2,
      "quantity": 2
    }
  ],
  "shippingName": "田中太郎",
  "shippingPostalCode": "123-4567",
  "shippingPrefecture": "東京都",
  "shippingCity": "渋谷区",
  "shippingAddressLine": "1-1-1 マンション101",
  "shippingPhone": "090-1234-5678",
  "notes": "午前中配送希望"
}
```

**レスポンス** (201 Created)
```json
{
  "id": 1,
  "userId": 1,
  "orderDate": "2024-01-01T10:00:00Z",
  "status": 0,
  "statusText": "注文確認中",
  "totalAmount": 2500.00,
  "shippingName": "田中太郎",
  "shippingPostalCode": "123-4567",
  "shippingPrefecture": "東京都",
  "shippingCity": "渋谷区",
  "shippingAddressLine": "1-1-1 マンション101",
  "shippingPhone": "090-1234-5678",
  "notes": "午前中配送希望",
  "createdAt": "2024-01-01T10:00:00Z",
  "updatedAt": "2024-01-01T10:00:00Z",
  "items": [...]
}
```

**処理フロー**:
1. **JWT解析**: Authorizationヘッダーからトークンを取得
2. **ユーザーID取得**: JWTトークンからNameIdentifierクレーム（ユーザーID）を取得
3. **リクエストボディ取得**: JSONから注文商品リストと配送情報を取得
4. **バリデーション**: 
   - itemsが空でないこと
   - 各商品のproductIdとquantityが正の整数であること
   - 配送情報の必須項目が入力されていること
5. **トランザクション開始**: データベーストランザクションを開始
6. **商品・在庫チェック**: 
   - 各商品がProductsテーブルに存在することを確認
   - 各商品の在庫数が注文数量以上であることを確認
7. **注文明細作成**: 
   - 各商品に対してOrderItemエンティティを作成
   - 注文時点の商品価格・名前・説明を保存
8. **合計金額計算**: 各明細の小計を合算
9. **在庫減算**: 各商品の在庫数から注文数量を減算
10. **注文エンティティ作成**: Orderエンティティを作成し、現在日時を設定
11. **データベース保存**: SaveChangesAsyncで全ての変更を保存
12. **トランザクションコミット**: 全ての処理が成功した場合にコミット
13. **JSON変換**: 作成された注文をOrderResponse形式で返却

**エラー処理**: 
- 商品不存在 → 400 Bad Request
- 在庫不足 → 400 Bad Request
- バリデーションエラー → 400 Bad Request
- データベースエラー → 500 Internal Server Error（トランザクションロールバック）

#### PUT /api/orders/{id}/status (UpdateOrderStatus Action)
**処理概要**: 注文のステータスを更新（ユーザー自身の注文のみ）

**リクエスト**
- **ヘッダー**: `Authorization: Bearer {JWT_TOKEN}`
- **URLパラメータ**:
  - `id` (int, 必須): 注文ID
- **リクエストボディ**:
```json
{
  "status": 5
}
```

**レスポンス** (204 No Content)
- レスポンスボディなし

**処理フロー**:
1. **JWT解析**: Authorizationヘッダーからトークンを取得
2. **ユーザーID取得**: JWTトークンからNameIdentifierクレーム（ユーザーID）を取得
3. **URLパラメータ取得**: ルートパラメータから注文IDを取得
4. **リクエストボディ取得**: JSONから新しいステータス値を取得
5. **注文検索**: ECShopContextを使用してOrdersテーブルから指定IDかつ該当ユーザーの注文を検索
6. **存在チェック**: 注文が見つからない場合は404エラー
7. **ステータス更新**: 注文のStatusプロパティを新しい値に更新
8. **更新日時設定**: UpdatedAtに現在日時を設定
9. **データベース保存**: SaveChangesAsyncで変更を保存
10. **レスポンス**: 204 No Contentを返却

**エラー処理**: 
- 注文不存在（他ユーザーの注文含む） → 404 Not Found
- 無効なステータス値 → 400 Bad Request
- 認証エラー → 401 Unauthorized

### 5.2 AdminController（注文管理関連）

#### GET /api/admin/orders (GetAllOrders Action)
**処理概要**: 全ユーザーの注文を取得（ページネーション対応）
1. **入力**: page, pageSize, status（クエリパラメータ）
2. **処理フロー**:
   - JWTトークンから管理者権限をチェック（HttpContext.User.FindFirst(ClaimTypes.NameIdentifier)）
   - ECShopContextを使用してUsersテーブルから管理者フラグを確認
   - statusパラメータがある場合、該当ステータスの注文のみフィルタリング
   - Skip()とTake()を使用してページネーション処理
   - Include()でOrderItems、Productも同時に取得
   - OrderDateで降順ソート
   - 総件数とページ情報を含むレスポンス作成
3. **出力**: ページネーション情報付き注文リスト（JSON）
4. **エラー処理**: 権限不足 → 403 Forbidden

#### PUT /api/admin/orders/{id}/status (UpdateOrderStatus Action)
**処理概要**: 任意の注文のステータスを更新（管理者権限）
1. **入力**: 注文ID（URLパラメータ）、OrderStatusRequest（リクエストボディ）
2. **処理フロー**:
   - JWTトークンから管理者権限をチェック
   - ECShopContextを使用してOrdersテーブルから指定IDの注文を検索
   - 注文存在チェック（見つからない場合は404エラー）
   - 注文のStatusプロパティを新しい値に更新
   - UpdatedAtに現在日時を設定
   - SaveChangesAsyncでデータベースに保存
3. **出力**: 更新成功メッセージ（JSON）
4. **エラー処理**: 注文不存在 → 404 Not Found

### 5.3 ビジネスロジック設計方針

#### 注文作成処理の責務
- **トランザクション管理**: データ整合性の保証
- **在庫チェック**: 商品存在確認・在庫数確認
- **価格計算**: 注文時点の価格で合計金額算出
- **在庫更新**: 注文確定時の在庫減算
- **注文履歴**: 注文時点の商品情報保存

#### 在庫管理の責務
- **在庫確認**: 注文前の在庫数チェック
- **在庫更新**: 注文確定時の在庫減算
- **在庫整合性**: 負の在庫を防ぐ制御
- **同時注文対応**: トランザクションによる排他制御

#### ステータス管理の責務
- **ステータス遷移**: ビジネスルールに基づく状態変更
- **権限制御**: ユーザー・管理者別の更新権限
- **履歴管理**: ステータス変更の記録
- **通知機能**: ステータス変更時の通知（将来実装）

#### エラーハンドリング方針
- **ArgumentException**: 商品不存在・在庫不足 → 400 Bad Request
- **InvalidOperationException**: ビジネスルール違反 → 400 Bad Request
- **UnauthorizedAccessException**: 権限不足 → 403 Forbidden
- **その他の例外**: 予期しないエラー → 500 Internal Server Error

## 6. フロントエンド設計

### 6.1 CheckoutForm.vue
```vue
<template>
  <div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">注文手続き</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- 注文内容確認 -->
          <div class="mb-4">
            <h6>注文内容</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>商品名</th>
                    <th>数量</th>
                    <th>単価</th>
                    <th>小計</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="item in cartItems" :key="item.id">
                    <td>{{ item.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>¥{{ formatPrice(item.price) }}</td>
                    <td>¥{{ formatPrice(item.price * item.quantity) }}</td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr>
                    <th colspan="3">合計</th>
                    <th>¥{{ formatPrice(totalAmount) }}</th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          
          <!-- 配送情報入力 -->
          <form @submit.prevent="handleSubmit">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">お名前 *</label>
                <input type="text" class="form-control" v-model="form.shippingName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">郵便番号 *</label>
                <input type="text" class="form-control" v-model="form.shippingPostalCode" 
                       pattern="[0-9]{3}-[0-9]{4}" placeholder="123-4567" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">都道府県 *</label>
                <select class="form-select" v-model="form.shippingPrefecture" required>
                  <option value="">選択してください</option>
                  <option v-for="pref in prefectures" :key="pref" :value="pref">{{ pref }}</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">市区町村 *</label>
                <input type="text" class="form-control" v-model="form.shippingCity" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">住所 *</label>
              <input type="text" class="form-control" v-model="form.shippingAddressLine" required>
            </div>
            <div class="mb-3">
              <label class="form-label">電話番号</label>
              <input type="tel" class="form-control" v-model="form.shippingPhone">
            </div>
            <div class="mb-3">
              <label class="form-label">備考</label>
              <textarea class="form-control" v-model="form.notes" rows="3"></textarea>
            </div>
          </form>
          
          <div v-if="error" class="alert alert-danger">
            {{ error }}
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
          <button type="button" class="btn btn-primary" @click="handleSubmit" :disabled="loading">
            <span v-if="loading" class="spinner-border spinner-border-sm me-2"></span>
            注文を確定する
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { orderService } from '../services/orderService';

export default {
  name: 'CheckoutForm',
  props: {
    cartItems: {
      type: Array,
      required: true
    }
  },
  data() {
    return {
      form: {
        shippingName: '',
        shippingPostalCode: '',
        shippingPrefecture: '',
        shippingCity: '',
        shippingAddressLine: '',
        shippingPhone: '',
        notes: ''
      },
      prefectures: [
        '北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県',
        '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県',
        // ... 他の都道府県
      ],
      loading: false,
      error: null
    };
  },
  computed: {
    totalAmount() {
      return this.cartItems.reduce((total, item) => total + (item.price * item.quantity), 0);
    }
  },
  methods: {
    async handleSubmit() {
      this.loading = true;
      this.error = null;
      
      try {
        const orderData = {
          items: this.cartItems.map(item => ({
            productId: item.id,
            quantity: item.quantity
          })),
          ...this.form
        };
        
        const order = await orderService.createOrder(orderData);
        this.$emit('order-created', order);
        
        // モーダルを閉じる
        const modal = bootstrap.Modal.getInstance(document.getElementById('checkoutModal'));
        modal.hide();
        
      } catch (error) {
        this.error = error.message;
      } finally {
        this.loading = false;
      }
    },
    
    formatPrice(price) {
      return new Intl.NumberFormat('ja-JP').format(price);
    }
  }
};
</script>
```

### 6.2 OrderHistory.vue
```vue
<template>
  <div class="order-history">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2>注文履歴</h2>
      <button class="btn btn-outline-primary" @click="loadOrders">
        <i class="bi bi-arrow-clockwise"></i> 更新
      </button>
    </div>
    
    <div v-if="loading" class="text-center py-4">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">読み込み中...</p>
    </div>
    
    <div v-else-if="error" class="alert alert-danger">
      {{ error }}
      <button class="btn btn-outline-danger btn-sm ms-2" @click="loadOrders">
        再試行
      </button>
    </div>
    
    <div v-else-if="orders.length === 0" class="text-center py-5">
      <i class="bi bi-cart-x display-1 text-muted"></i>
      <h3 class="mt-3 text-muted">注文履歴がありません</h3>
      <p class="text-muted">まだ注文をされていません。</p>
    </div>
    
    <div v-else class="row">
      <div class="col-12" v-for="order in orders" :key="order.id">
        <div class="card mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <h5 class="card-title">注文 #{{ order.id }}</h5>
                <p class="card-text">
                  <small class="text-muted">
                    {{ formatDate(order.orderDate) }}
                  </small>
                </p>
                <span class="badge" :class="getStatusBadgeClass(order.status)">
                  {{ order.statusText }}
                </span>
              </div>
              <div class="col-md-4 text-md-end">
                <p class="mb-1">
                  <strong>¥{{ formatPrice(order.totalAmount) }}</strong>
                </p>
                <p class="mb-2 text-muted">
                  {{ order.itemCount }}点
                </p>
                <button class="btn btn-outline-primary btn-sm" 
                        @click="viewOrderDetails(order.id)">
                  詳細を見る
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 注文詳細モーダル -->
    <OrderDetails 
      :order-id="selectedOrderId" 
      @close="selectedOrderId = null"
    />
  </div>
</template>

<script>
import { orderService } from '../services/orderService';
import OrderDetails from './OrderDetails.vue';

export default {
  name: 'OrderHistory',
  components: {
    OrderDetails
  },
  data() {
    return {
      orders: [],
      loading: false,
      error: null,
      selectedOrderId: null
    };
  },
  mounted() {
    this.loadOrders();
  },
  methods: {
    async loadOrders() {
      this.loading = true;
      this.error = null;
      
      try {
        this.orders = await orderService.getOrders();
      } catch (error) {
        console.error('注文履歴の読み込みに失敗しました:', error);
        this.error = '注文履歴の読み込みに失敗しました。';
      } finally {
        this.loading = false;
      }
    },
    
    formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    },
    
    formatPrice(price) {
      return new Intl.NumberFormat('ja-JP').format(price);
    },
    
    getStatusBadgeClass(status) {
      const statusClasses = {
        0: 'bg-warning',      // Pending
        1: 'bg-info',         // Confirmed
        2: 'bg-primary',      // Processing
        3: 'bg-success',      // Shipped
        4: 'bg-success',      // Delivered
        5: 'bg-danger'        // Cancelled
      };
      return statusClasses[status] || 'bg-secondary';
    },
    
    viewOrderDetails(orderId) {
      this.selectedOrderId = orderId;
    }
  }
}
</script>
```

## 7. エラーハンドリング

### 7.1 バックエンドエラー処理

#### 注文作成時のエラー処理
- **商品不存在エラー**: ArgumentException
- **在庫不足エラー**: InvalidOperationException
- **バリデーションエラー**: ArgumentException
- **データベースエラー**: トランザクションロールバック

#### エラーメッセージ定数
```csharp
public static class ErrorMessages
{
    public static class Order
    {
        public const string ORDER_NOT_FOUND = "注文が見つかりません";
        public const string INVALID_ORDER_STATUS = "無効な注文ステータスです";
        public const string ORDER_CANNOT_BE_MODIFIED = "この注文は変更できません";
    }
    
    public static class Product
    {
        public const string PRODUCT_NOT_FOUND = "商品が見つかりません";
        public const string INSUFFICIENT_STOCK = "在庫が不足しています";
    }
}
```

### 7.2 フロントエンドエラー処理

#### 注文処理エラー
- **ネットワークエラー**: 再試行ボタン表示
- **在庫不足エラー**: 該当商品の強調表示
- **認証エラー**: ログインページへリダイレクト
- **バリデーションエラー**: フォーム項目別エラー表示

## 8. パフォーマンス最適化

### 8.1 データベース最適化

#### インデックス設計
- Orders テーブル: UserId, OrderDate にインデックス
- OrderItems テーブル: OrderId, ProductId にインデックス
- 複合インデックス: (UserId, OrderDate) で注文履歴検索を高速化

#### クエリ最適化
- Include() を使用してN+1問題を回避
- 必要な列のみを選択するSelect()の活用
- ページネーション実装で大量データ対応

### 8.2 フロントエンド最適化

#### 状態管理最適化
- 注文データのローカルキャッシュ
- 不要な再レンダリングの防止
- 遅延ローディングによる初期表示高速化

#### UI/UX最適化
- ローディング状態の適切な表示
- エラー状態の分かりやすい表示
- 楽観的UI更新による体感速度向上

## 9. テスト設計

### 9.1 単体テスト

#### OrderService テスト
- **CreateOrderAsync_ValidOrder_ReturnsOrder**: 正常な注文作成
- **CreateOrderAsync_InsufficientStock_ThrowsException**: 在庫不足時の例外
- **CreateOrderAsync_ProductNotFound_ThrowsException**: 商品不存在時の例外
- **ValidateStockAsync_SufficientStock_ReturnsTrue**: 在庫十分時のチェック
- **ValidateStockAsync_InsufficientStock_ReturnsFalse**: 在庫不足時のチェック

#### OrderController テスト
- **CreateOrder_ValidRequest_ReturnsCreated**: 正常な注文作成API
- **CreateOrder_InvalidRequest_ReturnsBadRequest**: 無効リクエスト時のエラー
- **GetOrders_AuthenticatedUser_ReturnsOrders**: 認証済みユーザーの注文一覧
- **GetOrder_ValidId_ReturnsOrder**: 有効IDでの注文詳細取得

### 9.2 統合テスト

#### 注文フロー統合テスト
- **OrderFlow_CreateAndRetrieve_Success**: 注文作成から取得までの流れ
- **OrderFlow_StockUpdate_Success**: 注文作成時の在庫更新確認
- **OrderFlow_TransactionRollback_Success**: エラー時のロールバック確認

### 9.3 フロントエンドテスト

#### Vue.js コンポーネントテスト
- **CheckoutForm_ValidData_SubmitsOrder**: 有効データでの注文送信
- **CheckoutForm_InvalidData_ShowsErrors**: 無効データでのエラー表示
- **OrderHistory_LoadsOrders_DisplaysList**: 注文履歴の読み込み・表示
- **OrderDetails_ValidId_ShowsDetails**: 注文詳細の表示

## 10. セキュリティ考慮事項

### 10.1 認証・認可
- **注文作成**: 認証済みユーザーのみ
- **注文参照**: 自分の注文のみアクセス可能
- **ステータス更新**: 管理者権限または注文者本人のみ

### 10.2 入力検証
- **サーバーサイド**: 厳密なバリデーション実装
- **数量制限**: 異常な大量注文の防止
- **価格改ざん**: サーバーサイドで価格を再取得

### 10.3 データ保護
- **個人情報**: 配送先情報の適切な暗号化
- **決済情報**: 将来的にPCI DSS準拠
- **ログ出力**: 個人情報のマスキング

## 11. 運用・監視

### 11.1 ログ出力
- **注文作成**: 成功・失敗ログ
- **ステータス変更**: 変更履歴ログ
- **在庫更新**: 在庫変動ログ
- **エラー**: 詳細なエラー情報

### 11.2 メトリクス
- **注文数**: 日次・月次集計
- **売上金額**: 期間別売上
- **在庫回転率**: 商品別分析
- **注文完了率**: コンバージョン分析

### 11.3 アラート
- **在庫切れ**: 自動通知
- **注文エラー**: 異常検知
- **決済失敗**: 即座の対応
- **システム障害**: 緊急対応

## 12. 今後の拡張予定

### 12.1 機能拡張
- **決済システム**: クレジットカード・電子マネー対応
- **配送追跡**: 配送業者API連携
- **注文変更**: 発送前の注文内容変更
- **定期注文**: サブスクリプション機能

### 12.2 技術的改善
- **非同期処理**: メッセージキュー導入
- **マイクロサービス**: 注文サービスの分離
- **イベントソーシング**: 注文状態の履歴管理
- **CQRS**: 読み取り・書き込みの分離

### 12.3 運用改善
- **自動化**: 注文処理の自動化
- **分析**: 高度な売上分析
- **予測**: 需要予測システム
- **最適化**: 在庫最適化アルゴリズム
